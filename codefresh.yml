# Build a service with environment variables
version: '1.0'

steps:
  init_variables:
    title: Initializing variables...
    image: alpine
    commands:
      - cf_export MASTER_BRANCH=master
      - cf_export BUILD_HARNESS_VERSION=0.5.5
      - cf_export HUGO_CONFIG=deploy.toml
      - cf_export HTMLTEST_CONFIG=.htmltest.codefresh.yml
      - cf_export TMPDIR=/codefresh/volume

  semver:
    title: Export semantic version
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    working_directory: ./
    commands:
      - make git/show
      - make git/export | tee -a ${{CF_VOLUME_PATH}}/env_vars_to_export
      - make semver/show
      - make semver/export | tee -a ${{CF_VOLUME_PATH}}/env_vars_to_export

  build:
    title: Building Hugo static site...
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    working_directory: ./
    commands:
      # Install python3 to pass install deps asciinema
      - apk add --no-cache python3
      - make deps
      - make lint
      - make release
      - make build

  test:
    title: Running tests...
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    working_directory: ./
    environment:
      - "HUGO_EDIT_BRANCH=${{CF_BRANCH}}"
    commands:
      # Install python3 to pass install deps asciinema
      - apk add --no-cache python3
      - make deps
      - make lint
      - cat $HTMLTEST_CONFIG
      - make smoketest

  # Only deploy on tagged releases
  deploy:
    title: Pushing all artifacts to S3 bucket...
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    working_directory: ./
    commands:
      - make deploy
    when:
      condition:
        all:
          executeForTag: "'${{SEMVERSION_TAG}}' != ''"

  # Only reindex on tagged releases
  reindex:
    title: Updating algolia search index...
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    working_directory: ./
    commands:
      - make reindex
    when:
      condition:
        all:
          executeForTag: "'${{SEMVERSION_TAG}}' != ''"
