version: '1.0'
steps:
  deploy_helmfile:
    title: Deploy app with helmfile
    image: cloudposse/build-harness:${{BUILD_HARNESS_VERSION}}
    environment:
    - AWS_REGION=us-west-2
    - AWS_ACCESS_KEY_ID=${{AWS_ACCESS_KEY_ID}}          # for chamber
    - AWS_SECRET_ACCESS_KEY=${{AWS_SECRET_ACCESS_KEY}}  # for chamber
    - CHART_NAME=app
    - CHART_REPO_URL=${{STAGING_REPO_ENDPOINT}}
    - CHART_VERSION=${{SEMVERSION_COMMIT_SHORT}}
    - EXTERNAL_DNS_ALPHA_KUBERNETES_IO_TARGET=ingress.${{BASE_HOST}}
    - IMAGE_TAG=${{SEMVERSION_COMMIT_SHORT}}
    - INGRESS_HOST=app.${{BASE_HOST}}
    - KUBE_CONTEXT=${{KUBE_CONTEXT}}
    - NAMESPACE=${{NAMESPACE}}
    - RELEASE_NAME=${{RELEASE_NAME}}
    commands:
    # Touch .env to ensure it exists (depends on pipeline)
    - "touch .env"
    # Install or upgrade tiller
    - "make helm/toolbox/upsert"
    # Update values.yaml with envs from chamber
    - "chamber exec kops app -- env $(cat .env) envsubst < config/chart.yaml > config/${RELEASE_NAME}.yaml"
    # Deploy chart to cluster using helmfile (with chamber secrets)
    - "chamber exec kops app -- helmfile --file config/helmfile.yaml sync --concurrency 1 --args '--wait --timeout=600 --recreate-pods --force --reset-values'"
    when:
      condition:
        all:
          executeForMasterBranch: "'${{CF_BRANCH}}' == 'master'"
