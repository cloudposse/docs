---
title: datadog-monitor
sidebar_label: datadog-monitor
sidebar_class_name: command
custom_edit_url: https://github.com/cloudposse/terraform-aws-components/blob/main/modules/datadog-monitor/README.md
tags: [terraform, aws, datadog-monitor]
---

# Component: `datadog-monitor`

This component is responsible for provisioning Datadog monitors and assigning Datadog roles to the monitors.

It depends on the `datadog-configuration` component to get the Datadog API keys.

## Usage

**Stack Level**: Regional

Here's an example snippet for how to use this component:

```yaml
components:
  terraform:
    datadog-monitor:
      settings:
        spacelift:
          workspace_enabled: true
      vars:
        enabled: true
        local_datadog_monitors_config_paths:
          - "catalog/monitors/dev/*.yaml"
```

## Conventions

- Treat datadog like a separate cloud provider with integrations
  ([datadog-integration](https://docs.cloudposse.com/components/library/aws/datadog-integration)) into your accounts.

- Use the `catalog` convention to define a step of alerts. You can use ours or define your own.
  [https://github.com/cloudposse/terraform-datadog-platform/tree/master/catalog/monitors](https://github.com/cloudposse/terraform-datadog-platform/tree/master/catalog/monitors)

- The monitors catalog for the datadog-monitor component support datadog monitor exports. You can use
  [the status page of a monitor to export it from 'settings'](https://docs.datadoghq.com/monitors/manage/status/#settings).
  You can add the export to existing files or make new ones. Because the export is json formatted, it's also yaml
  compatible. If you prefer, you can convert the export to yaml using your text editor or a cli tool like `yq`.

## Adjust Thresholds per Stack

Since there are so many parameters that may be adjusted for a given monitor, we define all monitors through YAML. By
convention, we define the **default monitors** that should apply to all environments, and then adjust the thresholds per
environment. This is accomplished using the `datadog-monitor` components variable `local_datadog_monitors_config_paths`
which defines the path to the YAML configuration files. By passing a path for `dev` and `prod`, we can define
configurations that are different per environment.

For example, you might have the following settings defined for `prod` and `dev` stacks that override the defaults.

For the `dev` stack:

```
components:
  terraform:
    datadog-monitor:
      vars:
        # Located in the components/terraform/datadog-monitor directory
        local_datadog_monitors_config_paths:
          - catalog/monitors/*.yaml
          - catalog/monitors/dev/*.yaml # note this line
```

For `prod` stack:

```
components:
  terraform:
    datadog-monitor:
      vars:
        # Located in the components/terraform/datadog-monitor directory
        local_datadog_monitors_config_paths:
          - catalog/monitors/*.yaml
          - catalog/monitors/prod/*.yaml # note this line
```

Behind the scenes (with `atmos`) we fetch all files from these glob patterns, template them, and merge them by key. If
we peek into the `*.yaml` and `dev/*.yaml` files above you could see an example like this:

**components/terraform/datadog-monitor/catalog/monitors/elb.yaml**

```
elb-lb-httpcode-5xx-notify:
  name: "(ELB) {{ env }} HTTP 5XX client error detected"
  type: query alert
  query: |
    avg(last_15m):max:aws.elb.httpcode_elb_5xx{${context_dd_tags}} by {env,host} > 20
  message: |
    [${ dd_env }] [ {{ env }} ] lb:[ {{host}} ]
    {{#is_warning}}
    Number of HTTP 5XX client error codes generated by the load balancer > {{warn_threshold}}%
    {{/is_warning}}
    {{#is_alert}}
    Number of HTTP 5XX client error codes generated by the load balancer > {{threshold}}%
    {{/is_alert}}
    Check LB
  escalation_message: ""
  tags: {}
  options:
    renotify_interval: 60
    notify_audit: false
    require_full_window: true
    include_tags: true
    timeout_h: 0
    evaluation_delay: 60
    new_host_delay: 300
    new_group_delay: 0
    groupby_simple_monitor: false
    renotify_occurrences: 0
    renotify_statuses: []
    validate: true
    notify_no_data: false
    no_data_timeframe: 5
    priority: 3
    threshold_windows: {}
    thresholds:
      critical: 50
      warning: 20
  priority: 3
  restricted_roles: null
```

**components/terraform/datadog-monitor/catalog/monitors/dev/elb.yaml**

```
elb-lb-httpcode-5xx-notify:
  query: |
    avg(last_15m):max:aws.elb.httpcode_elb_5xx{${context_dd_tags}} by {env,host} > 30
  priority: 2
  options:
    thresholds:
      critical: 30
      warning: 10
```

## Key Notes

### Inheritance

The important thing to note here is that the default yaml is applied to every stage that it's deployed to. For dev
specifically however, we want to override the thresholds and priority for this monitor. This merging is done by key of
the monitor, in this case `elb-lb-httpcode-5xx-notify`.

### Templating

The second thing to note is `$\{ dd_env \}`. This is **terraform** templating in action. While double braces (`\{\{ env \}\}`)
refers to datadog templating, `$\{ dd_env \}` is a template variable we pass into our monitors. in this example we use it
to specify a grouping int he message. This value is passed in and can be overridden via stacks.

We pass a value via:

```
components:
  terraform:
    datadog-monitor:
      vars:
        # Located in the components/terraform/datadog-monitor directory
        local_datadog_monitors_config_paths:
          - catalog/monitors/*.yaml
          - catalog/monitors/dev/*.yaml
        # templatefile() is used for all yaml config paths with these variables.
        datadog_monitors_config_parameters:
          dd_env: "dev"
```

This allows us to further use inheritance from stack configuration to keep our monitors dry, but configurable.

Another available option is to use our catalog as base monitors and then override them with your specific fine tuning.

```
components:
  terraform:
    datadog-monitor:
      vars:
        local_datadog_monitors_config_paths:
          - https://raw.githubusercontent.com/cloudposse/terraform-datadog-platform/0.27.0/catalog/monitors/ec2.yaml
          - catalog/monitors/ec2.yaml
```

## Other Gotchas

Our integration action that checks for `'source_type_name' equals 'Monitor Alert'` will also be true for synthetics.
Whereas if we check for `'event_type' equals 'query_alert_monitor'`, that's only true for monitors, because synthetics
will only be picked up by an integration action when `event_type` is `synthetics_alert`.

This is important if we need to distinguish between monitors and synthetics in OpsGenie, which is the case when we want
to ensure clean messaging on OpsGenie incidents in Statuspage.

<!-- prettier-ignore-start -->
<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
<!-- hello terraform-docs -->
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
<!-- prettier-ignore-end -->

## Related How-to Guides

- [How to Onboard a New Service with Datadog and OpsGenie](https://docs.cloudposse.com/reference-architecture/how-to-guides/tutorials/how-to-implement-incident-management-with-opsgenie/how-to-onboard-a-new-service-with-datadog-and-opsgenie)
- [How to Sign Up for Datadog?](https://docs.cloudposse.com/reference-architecture/how-to-guides/tutorials/how-to-sign-up-for-datadog)
- [How to use Datadog Metrics for Horizontal Pod Autoscaling (HPA)](https://docs.cloudposse.com/reference-architecture/how-to-guides/tutorials/how-to-use-datadog-metrics-for-horizontal-pod-autoscaling-hpa)
- [How to Implement SRE with Datadog](https://docs.cloudposse.com/reference-architecture/how-to-guides/tutorials/how-to-implement-sre-with-datadog)

## Component Dependencies

- [datadog-integration](https://docs.cloudposse.com/components/library/aws/datadog-integration/)

## References

- [cloudposse/terraform-aws-components](https://github.com/cloudposse/terraform-aws-components/tree/main/modules/datadog-monitor) -
  Cloud Posse's upstream component



## CHANGELOG

### PR [#814](https://github.com/cloudposse/terraform-aws-components/pull/814)

#### Removed Dead Code, Possible Breaking Change

The following inputs were removed because they no longer have any effect:

- datadog_api_secret_key
- datadog_app_secret_key
- datadog_secrets_source_store_account
- monitors_roles_map
- role_paths
- secrets_store_type

Except for `monitors_roles_map` and `role_paths`, these inputs were deprecated in an earlier PR, and replaced with
outputs from `datadog-configuration`.

The implementation of `monitors_roles_map` and `role_paths` has been lost.

