---
title: "Quick Start"
sidebar_class_name: hidden
custom_edit_url: https://github.com/cloudposse/refarch-scaffold/blob/main/docs/docs/fundamentals/iam-identity.md
---

# Identity and Authentication

There are several methods available to sign in to AWS through a browser or terminal, such as AWS SAML or IAM Identity Center (successor to AWS Single Sign-On). Various tooling has been tried to support AWS SAML, like "saml2aws," and others to support AWS SSO, such as "aws sso login" and "aws configure," to manage terminal access. However, these tools often had issues, such as not handling all methods of login with different IdPs and using screenscraping, which caused anti-bot measures to block them, for example, Google Workspaces.

Cloud Posse's approach involves using IAM roles that provide highly precise control to different user groups. These groups are assigned to users through AWS SAML Apps or AWS SSO Groups ("Groups") and enable the user to assume roles into any allowed accounts. A significant advantage of this approach is the availability of an easy-to-use tool that works with all AWS sign-in methods. In the following pages, the Cloud Posse strategy will be explained in detail, demonstrating how it can be used to establish fine-grained access control for an entire organization.

import ReactPlayer from 'react-player';

<ReactPlayer controls url='https://docs.cloudposse.com/assets/refarch/handoffs/identity-and-authentication.mp4' />

## The Problem
One problem that many organizations face is choosing whether to use **AWS SAML** or **AWS IAM Identity Center (SSO)**.

### The Problem with Pure IAM Identity Center Permission Sets
While **IAM Identity Center (successor to AWS Single Sign-On)** seems like a best fit for managing a single pane of glass of users and their groups,
often the downsides are not caught until later.
Downsides such as the inability to easily switch accounts and difficulty with tooling to ensure a consistent login for
different groups while managing an AWS configuration file for all these different groups.

This presents a major problem in Terraform, where we need to be able to access the state bucket in the root account, then deploy resources to any given AWS Account. AWS SSO Permission Sets does not grant multi account access and would therefor not support any complex Terraform.

### The Problem with Pure AWS SAML Team Access Roles
**AWS SAML** on the other hand does not provide a central place for managing users, groups, and permissions. But AWS SAML does provide an easier login experience via the terminal and allows for multiple Identity Providers (IdP). Users and groups are managed by the IdP, while permissions are managed with AWS Teams and Team Roles with Terraform.

### The Problem with Tooling
Tooling is another issue that plagues the AWS login experience. Switching roles in the UI can be solved via a Google Chrome
plugin called [extend-roles](https://github.com/tilfinltd/aws-extend-switch-roles), but that requires using Chrome, Firefox,
or Microsoft Edge (or plug-in compatible browser like Opera) as a web browser. [Leapp](https://www.leapp.cloud/) is a great
tool for logging in, but can be a bit clumsy for switching roles.


Another common issue is granting the proper permission for a user to sign into any account.
AWS SAML signs into a single role in the Identity account, and that Identity role should have access to roles in other accounts.
On the other hand, AWS IAM Identity Center grants a Permission Set for each account
requiring the user to sign out and sign in to switch accounts.

## Our Solution

**Our goals: team oriented, highly accessible, easily configured**

Taking into account all the challenges of using AWS SSO and SAML, let's summarize our requirements:
- We need the ability to use AWS SAML or AWS IAM Identity Center
- We need a single tool to manage logins to the AWS Console and CLI
- We need the ability to switch roles into other accounts easily, with team and account specific permissions.
- We need to be able to concurrently assume roles into multiple accounts (E.g. with Terraform)

### Team Oriented: Multiple AWS Accounts, One Team, with Exact Permissions

We introduce the concept of a **_Team_**. This Team is a group of users with access to a given set of accounts with varying permissions.
If using AWS SSO, our convention is to use a one-to-one mapping with a User Group, but this is not required.

Every group of users has an identity Team, which the user immediately logs into. This is the purpose of the `identity` account.
From there, the user has the ability to assume roles, which permit the user to "sign-in" to the different AWS accounts that the
team has access.

We introduce the idea of a **_Team Role_**. This is a role in a given account (like `plat-dev`) that a Team is able
to assume from a Team. Team Roles provide standardized permission for all accounts. These roles are identical
in all accounts, but the only difference is which Team is able to assume the Team Role in that account.

For example, the `developers` team might have access to assume the `admin` Team Role in the `plat-sandbox` account but only access to assume the
`observer` role in the `plat-prod` account.

### Highly Accessible: No more chrome plugins, no more bash scripts

Now that we have the roles created with Teams and Team Roles, lets put it to work.

We need a tool that solves many problems listed above while being Multi-OS compatible and ideally programmable. We have tried
several tools, the one that works very well and appears to be gaining exponential traction is [Leapp](https://www.leapp.cloud/).

Leapp is a Desktop Application (and has a CLI) that manages your active sessions for your AWS Config. This
means it handles logging in, and assigning those credentials generated to a given AWS profile.

Before continuing on all the problems Leapp solves, we need to state that the AWS Configuration
file (`~/.aws/config`) is usually highly dependent on your sign-in method. Different sign-in methods use different
profile configurations. The beauty of using Leapp is we can have a single config file regardless of your sign-in method.
I will discuss this in the next section.

So Leapp manages our credentials. It does so in a couple beautiful ways.

1. It works with any Identity Provider, and since it's an Electron application, it can prompt for sign-in, in the app or in the browser of choice.
2. It automatically refreshes your AWS credentials before they expire (No mid-terraform apply failures from expired credentials)
3. If we are using AWS IAM Identity Center (SSO) it will sync the available `PermissionSets` from your login as available sessions.
4. It's Open Source

Since we auto-generate an AWS Configuration file and Leapp can use a CLI to create Sessions that manage Profile
credentials, we can set up automated AWS access for AWS IAM Identity Center or AWS SAML.

### Easily Configured: Identity Provider independent Configuration and Sign-in.

AWS Configuration files usually differ from AWS IAM Identity Center to AWS SAML. With Leapp however, we can use
the same configuration file and use Chained Roles in Leapp. **Chained Roles** in Leapp assume another role by configuration with a single user action.
For AWS IAM Identity Center this means we can create a Chained Role from our AWS IAM Identity Center Permission Sets to our Team
Entry Point. In regard to **Teams** this means that we can create a Chained Role session for our **Team Roles** to access `dev` or `prod`.

## Implementation

<img src="https://lucid.app/publicSegments/view/1eac6776-c23f-4b1f-8aec-c7f540470746/image.png" style={{width: '100%', minHeight: '480', height: 'auto', margin: '10', position: 'relative'}}/><br/>

The following components are designed to provision all primary user and system
roles into a centralized identity account. These components are expected to
be used together to provide fine-grained role delegation across the account
hierarchy.

### AWS Teams

The `aws-teams` component creates AWS Teams in the Identity account. The **Team** is
the entry point for a group of users, and the Identity account acts as an "Identity Hub"
for centralized role assumption management across all delegated accounts. Those roles are
then assumed by the team members after they login to their identity provider (AWS SSO or AWS SAML).

### AWS Team Roles

The `aws-team-roles` component defines common IAM Roles in all accounts, as well
as defines the AWS Team(s) able to assume the role in any account.

These roles should be identical in all accounts, such that you can always expect
`admin` to be `admin`, `poweruser` to be `poweruser`, and `observer` to be
`observer`. The only difference between accounts is which AWS Team is able to
assume the role.

### AWS IAM Identity Center (SSO)

The `aws-sso` component connects AWS IAM Identity Center (Successor to AWS Single
Sign-On) Groups to Permission Sets. Permission Sets grant access to `aws-teams` in
the Identity account or (optional) access to an individual account for convenience.

Permission Sets other than the Identity Team Access Permission Set are used only for
console and cli access to a single account. These are redundant with AWS Team Roles
but are useful for quickly accessing a given account with limited permission.

### AWS SAML

The `aws-saml` component provides SAML access for Admin users to connect to
the Identity account admin role `aws-teams` without AWS IAM Identity
Center (Successor to AWS Single Sign-On).

This component creates an Identity Provider (IdP) in the Identity account
to allow federated access to an identity role. Follow the Identity Providers
documentation for adding a SAML login.


## Setting Up Access

Leapp is an AWS credential management tool that will simplify the authentication process.
Leapp requires the AWS Session Manager plugin as well. Install both now.

For example with `brew`, see below. Otherwise check
[Leapp documentation](https://docs.leapp.cloud/latest/installation/install-leapp/)

```bash
brew install --cask leapp
brew install --cask session-manager-plugin
```

Once Leapp is installed, follow these steps to set up local AWS access with AWS Identity Center (SSO).

1. Launch Leapp
2. Create a new Integration
3. Fill out Single Sign-On configuration
```
Alias: acme (This can be whatever you would like to label the Integration in Leapp)
Portal URL: https://d-1111aa1a11.awsapps.com/start/ (Set this to your SSO Launch URL)
AWS Region: us-east-1 (Your primary region)
Auth. Method: In-browser
```

4. Click Integration “dots” and select “Login”. This should launch a tab in your web browser.
5. Log into your IdP for your Organization and “Allow” Authorization request
6. Create a “Chained Session” from the `core-identity` account with the `IdentityDevopsTeamAccess` Permission Set

:::info

This Permission Set will match the given Team name. For example, Developers will use `IdentityDevelopersTeamAccess`
and DevOps will use `IdentityDevopsTeamAccess`.

:::

7. Fill out the Chained Session configuration for connecting to `acme-identity`
```
Named profile: acme-identity
Session Alias: (whatever you like) core-identity
AWS Region: us-east-1
Role ARN: arn:aws:iam::666666666666:role/acme-core-gbl-identity-devops
Role Session Name: acme-identity
Assumer Session: core-identity
```

:::info

This Team will match the given Team name. For example, Developers will use `acme-core-gbl-identity-developers`
and DevOps will use `acme-core-gbl-identity-devops`.

:::

8. (Optional) Pin the new `core-identity` IAM Role Chained Session
9. Connect to `core-identity` IAM Role Chained Session
10. Open your terminal of choice, navigate to the `infrastructure` repository, and launch Geodesic

```bash
make build run/new
```

11. Done! Confirm that authentication is properly set up by calling the AWS from within Geodesic:

```bash
aws sts get-caller-identity
```

This should return the given Identity role. Geodesic will also show a green tick-mark in the shell prompt to show the current AWS profile.


## Conclusion

We now have a system in place where teams roles and their permissions are created in Terraform, but the users assigned
to those teams are managed through an Identity Provider. These Teams have fine-grained permissions per account, and we
can assume any role and manage our sessions through a single pane of glass.

## References

- [extend-roles](https://github.com/tilfinltd/aws-extend-switch-roles)
- [Leapp](https://docs.leapp.cloud/latest/installation/install-leapp/)
- [`aws-teams` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-teams)
- [`aws-sso` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-sso)
- [`aws-saml` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-saml)
- [`aws-teams` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-teams)
- [`aws-team-roles` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-team-roles)

## FAQ

### How do I create new teams?
Follow the docs in the readme of the `aws-team`
component. [`aws-teams` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-teams)

### How do I set up Leapp?

See ["Setting Up Access"](#setting-up-access) above.

### Known Leapp Limitation with Windows and WSL

Leapp sets AWS credentials to the home directory wherever it is running. So if you run Leapp on Windows, that will be set to the Windows home directory.
Then when you start WSL2, that will have a different home directory. The workaround is to copy AWS credentials from the Windows home directory over to
the WSL2 home directory.
[ref](https://github.com/Noovolari/leapp/issues/153)

```bash
cp -r /mnt/c/Users/<username>/.aws ~/.aws
```

### How can I set varying permission for a role in several accounts?

Keep in mind that Team Roles are designed to identical in all delegated accounts. However, you can still modify permission on
an account-by-account basis if required.

Override your [`aws-team-roles` component](https://github.com/cloudposse/terraform-aws-components/tree/master/modules/aws-team-roles) stack configuration to include different permissions when deployed to a given account.

### Why not use AWS Control Tower?

AWS Control Tower does not support Terraform. Using Terraform, we have complete control over the Organization, Organizational Unit, and Account provisioning process.

### Why not just use AWS SSO?

The primary reason is that cross-account terraform is not supported with AWS SSO Permission Sets. We cannot apply Terraform across the account
hierarchy with a single Permission Set, so instead we combine AWS SSO with our AWS Teams and Team Roles.

AWS SSO is fine for business users but less so for DevOps teams.
