---
title: "Deploying Networks"
sidebar_position: 0
---

# Deploying the Network

## Requirements

Before deploying the Networking layer, first purchase the vanity and service domains chosen by ADR
[2001](/reference-architecture/reference/adrs/jumpstart/service-discovery-domain/) and
[2002](/reference-architecture/reference/adrs/jumpstart/decide-on-vanity-domain/)

When registering a new domain, we have the option of using Route53’s built-in registrar or using an existing registrar.
Many enterprise-scale organizations use MarkMonitor to manage their domain portfolio. Our convention is to use the `dns`
account as the registrar.

**Note**, the AWS Route53 Registrar cannot be automated with Terraform, so ClickOps is still required for domain
registration.

[Registering domain names using Amazon Route 53 - Amazon Route 53](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar.html)

We recommend checking with your legal department on where they want to consolidate domain ownership. It has larger
ramifications as to IP/trademark defense.

## Deployment

First, vendor the networking components by running the following:

```bash
atmos workflow vendor -f network
```

Once this is done, initialize all the VPCs in every configured region by running the following command:

```bash
atmos workflow deploy/vpc -f network
```

Next, go ahead and set up the Transit Gateway (TGW) by running the following:

```bash
atmos workflow deploy/tgw -f network
```

## Known Issues

Please NOTE! At this time you will need to make sure that all EKS VPCs are commented out in the TGW catalog. This is
because the components currently have a race condition requiring EKS clusters to exist before the TGW can be
provisioned. This will be fixed in the future, but for now comment out the cluster variable until clusters are created.

It's worth noting that propagation can fail during provisioning of Transit Gateway spokes. You'll likely see an error
like this:

```
╷
│ Error: reading EC2 Transit Gateway Route Table Propagation (tgw-rtb-*_tgw-attach-*): empty result
│
│   with module.tgw_hub_routes.aws_ec2_transit_gateway_route_table_propagation.default["plat-sandbox"],
│   on .terraform/modules/tgw_hub_routes/main.tf line 71, in resource "aws_ec2_transit_gateway_route_table_propagation" "default":
│   71: resource "aws_ec2_transit_gateway_route_table_propagation" "default" {
│
```

If this happens, you can safely wait a minute or two and then re-attempt the provisioning.

### Redeploy `tgw` when Deploying a New EKS Cluster

The file `stacks/catalog/tgw/hub.yaml` and the separate `tgw/spokes` in each `stacks/org/**/global-region/network.yaml`
potentially contain references to EKS Clusters using the `eks_component_names` variable. If you add an EKS Cluster, then
you will want to look up the individual `spoke` and `hub` components that are affected. If you are using cross-region
`tgw/cross-region-hub-connector` components, you will also want to update `eks_component_names` on the regional
connections.

```
atmos workflow deploy/tgw -f network
```
