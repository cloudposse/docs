---
title: "Initializing the Terraform State S3 Backend"
sidebar_label: "Initialize Terraform Backend"
sidebar_position: 3
---
import Intro from '@site/src/components/Intro';
import KeyPoints from '@site/src/components/KeyPoints';
import Note from '@site/src/components/Note';
import Steps from '@site/src/components/Steps';
import Step from '@site/src/components/Step';
import StepNumber from '@site/src/components/StepNumber';
import AtmosWorkflow from '@site/src/components/AtmosWorkflow';
import ActionCard from '@site/src/components/ActionCard';
import PrimaryCTA from '@site/src/components/PrimaryCTA';

<Intro>
Follow these steps to configure and initialize the Terraform state backend using Atmos, ensuring proper setup of the infrastructure components and state management.
</Intro>

| Steps                     | Actions                                   |
| ------------------------- | ----------------------------------------- |
| Configure Terraform state | `atmos workflow init/tfstate -f quickstart/foundation/accounts` |

## Setting up the Terraform State Backend

This is where we configure and run Atmos. Atmos is a workflow automation tool that we will use to call Terraform which
will provision all the accounts and resources you need to create and manage infrastructure. The Atmos configuration can
be found in the `atmos.yaml`.

If you're unfamiliar with atmos, you can read more about it [here](https://atmos.tools).

If you look at `components/terraform/`, you'll see a bunch of directories. These contain Terraform "root modules" that are provisioned with Atmos. At first they'll only have their vendor files, such as `components/terraform/tfstate-backend/component.yaml`.

<Steps>
  <Step>
    ## <StepNumber/> Vendor the Terraform State Backend component

    Vendor the Terraform State Backend component by running the following command.

    :::tip What is Vendoring?

    Vendoring downloads the upstream component files from a central repository at a specified version. In this case, we are pulling the baseline components, which include all account components, the Terraform State component, and other necessary files for setting up the account foundation. 
    
    This step only downloads the files to your local project - it does not deploy or make any changes to your infrastructure.

    [Read more about vendoring with Atmos](https://atmos.tools/core-concepts/vendor/)

    :::

    <AtmosWorkflow workflow="vendor" fileName="quickstart/foundation/accounts" />

  </Step>
  <Step>
    ## <StepNumber/> Request S3 Bucket Policy Size Quota Increase

    The reference architecture follows the principle of least privilege by listing every specific ARN explicitly in the
    `tfstate-backend` S3 bucket policy. This ensures only known, authorized roles and permission sets can access
    Terraform state. Because explicit ARNs produce a larger policy, the default S3 bucket policy size limit of 20KB may
    be exceeded.

    Before deploying the Terraform state backend, request a service quota increase for the S3 bucket policy size in the
    **root** account:

    ```bash
    aws service-quotas request-service-quota-increase \
      --service-code s3 \
      --quota-code L-DC2B2D3D \
      --desired-value 40
    ```

    This requests a 40KB limit, which provides sufficient headroom for organizations with many accounts.

    :::tip
    The `deploy/s3-quota` workflow step in the accounts layer workflow already includes this quota request. If you are
    following the quickstart and running `atmos workflow all -f quickstart/foundation/accounts`, this step is handled
    automatically and you do not need to run the command manually.
    :::

    Organizations preferring a smaller policy can substitute wildcard ARN patterns (e.g.
    `arn:aws:iam::*:role/acme-*-gbl-*-terraform`) in the `tfstate-backend` catalog defaults, but additional changes
    may also be needed to fit within the default 20KB limit. We recommend requesting the quota increase so the bucket
    policy size is not a constraint.

  </Step>
  <Step>
    ## <StepNumber/> Initialize the Terraform State Backend

    Run the following command to initialize the Terraform State Backend. This workflow has two steps:
    - Create the backend using a local Terraform state
    - Once the backend bucket exists, migrate the state file into the newly created S3 bucket

    <AtmosWorkflow workflow="init/tfstate" fileName="quickstart/foundation/accounts" />
  </Step>

  <Step>
    ## <StepNumber/> Migrate all workspaces to S3

    When prompted, type `yes` to migrate all workspaces to S3.

    ```shell
    Initializing the backend...
    Do you want to migrate all workspaces to "s3"?
    ```
  </Step>
</Steps>

:::info Granting SuperAdmin Access to Terraform State

The IAM User for SuperAdmin will be granted access to Terraform State by principal ARN. This ARN is passed to the
`tfstate-backend` stack catalog under `allowed_principal_arns`. Verify that this ARN is correct now. You may need to
update the root account ID.

:::

## References

- Review the [Structure of Terraform S3 State Backend Bucket](/layers/accounts/tutorials/terraform-s3-state/)

<ActionCard title="Next Steps">
  Now that the Terraform state backend is initialized, you're ready to deploy all AWS accounts in your organization.
  <PrimaryCTA to="/layers/accounts/deploy-accounts">Deploy Accounts</PrimaryCTA>
</ActionCard>
