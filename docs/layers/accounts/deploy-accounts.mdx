---
title: "Deploying AWS Accounts"
sidebar_label: "Deploy Accounts"
sidebar_position: 4
description: Deploy AWS accounts with `atmos` workflows and ClickOps.
---
import Intro from '@site/src/components/Intro';
import KeyPoints from '@site/src/components/KeyPoints';
import Steps from '@site/src/components/Steps';
import Step from '@site/src/components/Step';
import StepNumber from '@site/src/components/StepNumber';
import Note from '@site/src/components/Note';

<Intro>
This step-by-step process outlines how to deploy AWS accounts using `atmos` workflows and ClickOps steps. It covers necessary preparations, such as configuring the AWS Organization, increasing account quotas, and verifying account configurations. The guide details the deployment processes and post-deployment configurations, including setting up account settings, enabling AWS RAM for Organizations, and performing certain manual configurations via ClickOps.
</Intro>

| Steps                     | Actions                                              |
| ------------------------- | ---------------------------------------------------- |
| Deploy AWS Organization   | `atmos workflow deploy/organization -f accounts`     |
| Prepare accounts creation | Click Ops                                            |
| Deploy accounts           | `atmos workflow deploy/accounts -f accounts`         |
| Deploy accounts settings  | `atmos workflow deploy/account-settings -f accounts` |
| Finalize account setup    | Click Ops                                            |

<Steps>
  <Step>
    ## <StepNumber/> Prepare Account Deployment

    Review the "account" configuration in the stack catalog. **This is the hardest part to change/fix once the accounts are
    provisioned**. If you aren't confident about the email configuration, account names, or anything else, now is the time
    to make changes or ask for help.

    You should double-check the following:

    1. Check that `stacks/catalog/account.yaml` has the values you expect, especially account email format
    2. Run `atmos describe component account -s core-gbl-root` to inspect the final component configuration (e.g. _after_
      all the mixins have been imported)
    3. Plan the run with `atmos terraform plan account -s core-gbl-root`
  </Step>

  <Step>
    ## <StepNumber/> Deploy the AWS Organization:

    ```bash
    atmos workflow deploy/organization -f accounts
    ```
  </Step>

  <Step>
    ## <StepNumber/> Configure Root Account as Organization

    Before performing the "Deploying Accounts" step, the root account needs to be configured as an AWS Organization.

    This process also enables [AWS RAM for Organizations](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_enable-ram.html) via a CLI command, which is required for connecting the Organization.
  </Step>

  <Step>
    ## <StepNumber/> Raise Account Limits

    To deploy all accounts, we need to request an increase of the Account Quota from AWS support, which requires an AWS Organization to be created first.

    From the `root` account (not `SuperAdmin`), increase the [account quota to 20+](https://us-east-1.console.aws.amazon.com/servicequotas/home/services/organizations/quotas) for the Cloud Posse reference architecture, or more depending on your business use-case

  </Step>

  <Step>
    ## <StepNumber/> Deploying Accounts

    <Note title="important">
      With the addition of support for dynamic Terraform roles, our `baseline` cold start refarch layer now depends
      on/requires that we have `aws-teams` and `aws-team-roles` stacks configured. This is because `account-map` uses those
      stacks to determine which IAM role to assume when performing Terraform in the account, and almost every other component
      uses `account-map` (indirectly) to chose the role to assume. However, these components do _not_ need to be deployed yet.
    </Note>

    Again verify the "account" configuration in `stacks/catalog/account.yaml`. In the next step, we will create and configure all accounts in the AWS Organization using the configuration in that stack file.

    Once confident, begin the accounts deployment:

    ```bash
    atmos workflow deploy/accounts -f accounts
    ```

    These deployments will create all AWS member accounts and store relevant account metadata as "mappings" in the Terraform
    outputs of the `account-map` component. Rather than querying this `account` component each time we need an Account ID or
    role, we provision a static component `account-map`.

    <Note title="important">
    Always run `atmos terraform apply account-map -s core-gbl-root` after provisioning accounts.
    </Note>

    Once you've created the accounts, you'll need to provision the baseline configuration within the accounts themselves.
    This is accomplished by running `atmos workflow deploy/account-settings -f accounts`.

    The workflows will kick off several sequential Terraform runs to provision all the AWS member account settings for
    member accounts in the Organization.
  </Step>

  <Step>
    ### <StepNumber/> ClickOps to Complete Account Setup

    <Steps>
      1. For each new account:
         <Steps>
         1. Perform a password reset by attempting to log in to the AWS console as a "root user" using that account's email address
         1. Click the "Forgot password?" link
         1. You will receive a password reset link via email, which should be forwarded to the shared Slack channel for automated messages. Click the link
         1. Enter a new password

            <Note title="tip">
             Use 1Password or Random.org to create a password 26-38 characters long, including at least 3 of each class of character: lower case, uppercase, digit, and symbol. You may need to manually combine or add to the generated password to ensure 3 symbols and digits are present.
            </Note>

         1. Save the email address and generated password as web login credentials in 1Password
         1. Finally, save the account number in a separate field
         </Steps>

      1. Log in using the new password, choose "My Security Credentials" from the account dropdown menu and set up Multi-Factor Authentication (MFA) to use a Virtual MFA device.

      1. Save the MFA TOTP key in 1Password by using 1Password's TOTP field and built-in screen scanner, and save the Virtual MFA ARN

      1. Enable any necessary optional regions

      1. Optional, but highly recommended - unsubscribe the account's email address from all marketing emails

    </Steps>

    For more details, review
    [the detailed "AWS Cold Start" documentation](/layers/accounts/tutorials/manual-configuration/#configure-root-account-credentials-for-each-account).
  </Step>
</Steps>
