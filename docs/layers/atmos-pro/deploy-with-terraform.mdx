---
title: "Deploy Plan File Storage with Atmos and Terraform"
sidebar_label: "Deploy Plan Storage"
sidebar_position: 2
---
import Intro from '@site/src/components/Intro';
import KeyPoints from '@site/src/components/KeyPoints';
import Steps from '@site/src/components/Steps';
import Step from '@site/src/components/Step';
import StepNumber from '@site/src/components/StepNumber';
import TaskList from '@site/src/components/TaskList';
import ActionCard from '@site/src/components/ActionCard';
import PrimaryCTA from '@site/src/components/PrimaryCTA';
import AtmosWorkflow from '@site/src/components/AtmosWorkflow';
import CollapsibleText from '@site/src/components/CollapsibleText';
import CodeBlock from '@theme/CodeBlock';
import Note from '@site/src/components/Note';

<Intro>
  Deploy the AWS infrastructure required for Atmos Pro using Atmos and Terraform. This guide walks through deploying the GitHub OIDC provider and IAM roles needed for GitHub Actions to authenticate with AWS, along with the S3 bucket and DynamoDB table for plan file storage.
</Intro>

:::info GitOps Terminology
The workflows and components currently use "gitops" terminology. This will be updated to "atmos-pro" in a future release.
:::

<KeyPoints title="Before You Begin">
  <TaskList>
    - Terraform state backend deployed ([Initialize Terraform State](/layers/accounts/initialize-tfstate/))
    - AWS accounts provisioned ([Deploy Accounts](/layers/accounts/deploy-accounts/))
    - Atmos Auth configured for local deployments ([How to Log Into AWS](/layers/identity/how-to-log-into-aws/))
  </TaskList>
</KeyPoints>

## Overview

Atmos Pro dispatches GitHub Actions workflows that run in **your** GitHub repository. These workflows require three categories of AWS infrastructure:

### Plan File Storage

S3 bucket and DynamoDB table to store Terraform plan files between the plan and apply phases, plus an IAM role to access them:

<dl>
  <dt><code>s3-bucket/gitops</code></dt>
  <dd>Stores plan files generated by GitHub Actions during <code>terraform plan</code> and retrieves them during <code>terraform apply</code>. This ensures the exact plan reviewed in a PR is what gets applied on merge. Created with the <a href="/components/library/aws/s3-bucket/"><code>s3-bucket</code></a> component.</dd>

  <dt><code>dynamodb/gitops</code></dt>
  <dd>Tracks plan file metadata and maps git SHAs to their corresponding plan files, ensuring the correct plan is retrieved for each apply. This guarantees that merging a PR applies exactly the plan that was reviewed, even if multiple plans exist. Created with the <a href="/components/library/aws/dynamodb/"><code>dynamodb</code></a> component.</dd>

  <dt><code>iam-role/gitops</code></dt>
  <dd>Grants GitHub Actions permission to read and write plan files in S3 and DynamoDB. This role is assumed via OIDC and is deployed only in the account containing the plan storage resources. Created with the <a href="/components/library/aws/iam-role/"><code>iam-role</code></a> component.</dd>
</dl>

### Terraform Execution Roles

IAM roles deployed in **every account** that allow GitHub Actions to run Terraform plan and apply:

<dl>
  <dt><code>iam-role/planner</code></dt>
  <dd>Read-only role for running <code>terraform plan</code>. Grants permissions to read Terraform state and AWS resources but not modify them. Used by plan workflows to safely preview changes without risk of accidental modifications. Created with the <a href="/components/library/aws/iam-role/"><code>iam-role</code></a> component.</dd>

  <dt><code>iam-role/terraform</code></dt>
  <dd>Write role for running <code>terraform apply</code>. Grants full permissions to create, modify, and delete AWS resources as defined in your Terraform configurations. Used by apply workflows after changes are approved and merged. Created with the <a href="/components/library/aws/iam-role/"><code>iam-role</code></a> component.</dd>
</dl>

<Note>
These roles are configured through [Atmos Auth](/layers/identity/atmos-auth/) and deployed as part of the [Identity layer](/layers/identity/).
</Note>

### GitHub OIDC Provider

Enables GitHub Actions to authenticate with AWS without long-lived credentials. The OIDC provider must be deployed in **every account** where GitHub Actions needs to assume roles.

<dl>
  <dt><code>github-oidc-provider</code></dt>
  <dd>Establishes a trust relationship between GitHub and AWS, allowing GitHub Actions workflows to assume IAM roles without storing AWS credentials as secrets. GitHub's OIDC tokens are exchanged for temporary AWS credentials. Must be deployed in each account where roles will be assumed. Created with the <a href="/components/library/aws/github-oidc-provider/"><code>github-oidc-provider</code></a> component.</dd>
</dl>

<Note>
The GitHub OIDC provider is likely already deployed as part of the [Identity layer](/layers/identity/).
</Note>

## Configuration

<Steps>
  <Step>
    ### <StepNumber/> Deploy S3 Bucket and DynamoDB Table

    The plan file storage requires an S3 bucket to store plan files and a DynamoDB table to track metadata and map git SHAs to plans.

    <Note>
    Below is an example only. The latest version will be included with the reference architecture package.
    </Note>

    <CollapsibleText type="medium">
      <CodeBlock language="yaml" title="stacks/catalog/gitops/defaults.yaml">
{`components:
  terraform:
    # S3 Bucket for storing Terraform Plans
    gitops/s3-bucket:
      settings:
        pro:
          enabled: false
      metadata:
        component: s3-bucket
      vars:
        name: gitops-plan-storage
        allow_encrypted_uploads_only: false

    # DynamoDB table used to store metadata for Terraform Plans
    gitops/dynamodb:
      settings:
        pro:
          enabled: false
      metadata:
        component: dynamodb
      vars:
        name: gitops-plan-storage
        # This key (case-sensitive) is required for the cloudposse/github-action-terraform-plan-storage action
        hash_key: id
        range_key: ""
        # Only these 2 attributes are required for creating the GSI,
        # but there will be several other attributes on the table itself
        dynamodb_attributes:
          - name: 'createdAt'
            type: 'S'
          - name: 'pr'
            type: 'N'
        # This GSI is used to Query the latest plan file for a given PR.
        global_secondary_index_map:
          - name: pr-createdAt-index
            hash_key: pr
            range_key: createdAt
            projection_type: ALL
            non_key_attributes: []
            read_capacity: null
            write_capacity: null
        # Auto delete old entries
        ttl_enabled: true
        ttl_attribute: ttl`}
      </CodeBlock>
    </CollapsibleText>

  </Step>

  <Step>
    ### <StepNumber/> Configure GitHub Repository Trust

    All IAM roles (both GitOps and Terraform execution) need to trust your GitHub repository.

    <Note>
    Below is an example only. The latest version will be included with the reference architecture package.
    </Note>

    <CollapsibleText type="medium">
      <CodeBlock language="yaml" title="stacks/catalog/iam-role/gitops.yaml">
{`components:
  terraform:
    iam-role/gitops:
      metadata:
        component: iam-role
      vars:
        enabled: true
        name: gitops
        role_description: |
          Role for GitHub Actions to access the GitOps resources, such as the S3 Bucket and DynamoDB Table.
        # Grants access to GitHub Actions via OIDC
        github_oidc_provider_enabled: true
        github_oidc_provider_arn: !terraform.state github-oidc-provider oidc_provider_arn
        trusted_github_org: acme
        trusted_github_repos:
          - acme/infrastructure
        policy_statements:
          AllowDynamodbAccess:
            effect: "Allow"
            actions:
              - "dynamodb:List*"
              - "dynamodb:DescribeReservedCapacity*"
              - "dynamodb:DescribeLimits"
              - "dynamodb:DescribeTimeToLive"
            resources:
              - "*"
          AllowDynamodbTableAccess:
            effect: "Allow"
            actions:
              - "dynamodb:BatchGet*"
              - "dynamodb:DescribeStream"
              - "dynamodb:DescribeTable"
              - "dynamodb:Get*"
              - "dynamodb:Query"
              - "dynamodb:Scan"
              - "dynamodb:BatchWrite*"
              - "dynamodb:CreateTable"
              - "dynamodb:Delete*"
              - "dynamodb:Update*"
              - "dynamodb:PutItem"
            resources:
              - !terraform.state gitops/dynamodb core-use2-auto ".table_arn + ""/*"""
              - !terraform.state gitops/dynamodb core-use2-auto table_arn
          AllowS3Actions:
            effect: "Allow"
            actions:
              - "s3:ListBucket"
            resources:
              - !terraform.state gitops/s3-bucket core-use2-auto bucket_arn
          AllowS3ObjectActions:
            effect: "Allow"
            actions:
              - "s3:*Object"
            resources:
              - !terraform.state gitops/s3-bucket core-use2-auto ".bucket_arn + ""/*"""`}
      </CodeBlock>
    </CollapsibleText>

    The Terraform execution roles (`iam-role/planner` and `iam-role/terraform`) use the same trust pattern and are configured in the [Identity layer](/layers/identity/deploy/).

  </Step>

  <Step>
    ### <StepNumber/> Verify GitHub Workflow Permissions

    Your GitHub Action workflows need specific permissions to authenticate via OIDC:

    ```yaml
    permissions:
      id-token: write  # Required for requesting the JWT
      contents: read   # Required for actions/checkout
    ```

    These permissions are already configured in the reference architecture workflows.

  </Step>
</Steps>

## Deployment

<Steps>
  <Step>
    ### <StepNumber/> Vendor Components

    The GitOps stacks depend on components that may already exist in your component library (`s3-bucket` and `dynamodb`) and adds new components for GitHub OIDC authentication. Vendor these components with the included Atmos workflow:

    <AtmosWorkflow workflow="vendor" fileName="quickstart/foundation/gitops" />

    Alternatively, use [Atmos Vendoring](https://atmos.tools/core-concepts/components/vendoring) directly.

  </Step>

  <Step>
    ### <StepNumber/> Deploy Infrastructure

    Deploy the Atmos Pro infrastructure components:

    <AtmosWorkflow workflow="deploy" fileName="quickstart/foundation/gitops" />

    This workflow deploys the **Plan File Storage** and **GitHub OIDC** integration:

    <Steps>
    1. **`github-oidc-provider`** — Creates the OIDC provider in this account if not already deployed
    1. **`s3-bucket/gitops`** — S3 bucket for storing Terraform plan files
    1. **`dynamodb/gitops`** — DynamoDB table for plan file metadata and locking
    1. **`gitops-iam-policy`** — IAM policy granting access to plan storage resources
    1. **`iam-role/gitops`** — IAM role for accessing plan file storage (single account)
    </Steps>

    :::info Terraform Execution Roles
    The `iam-role/planner` and `iam-role/terraform` roles are deployed separately as part of the [Identity layer](/layers/identity/deploy/). These roles exist in every account and are configured through Atmos Auth.
    :::

  </Step>
</Steps>

## Verification

After deployment, verify the GitOps infrastructure is correctly configured:

<TaskList>
- GitHub OIDC provider exists in every account
- S3 bucket for plan file storage is created
- DynamoDB table for plan file metadata is created
- IAM role `gitops` exists and trusts your GitHub repository
- IAM policy grants access to the plan storage resources
- IAM roles `planner` and `terraform` exist in every account (deployed via [Identity layer](/layers/identity/deploy/))
</TaskList>

You can test the setup by creating a pull request — Atmos Pro will attempt to run plans using the deployed infrastructure.

<ActionCard title="Next Steps">
  With the AWS infrastructure deployed, verify your Atmos Pro setup by testing the GitHub integration.
  <PrimaryCTA to="/layers/atmos-pro/setup/#verification">Verify Setup</PrimaryCTA>
</ActionCard>