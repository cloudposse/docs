workflows:
  all:
    steps:
      - command: workflow init/artifact-bucket -f quickstart/app/app-on-lambda-with-atmos
      - command: workflow init/app-on-lambda-with-atmos -f quickstart/app/app-on-lambda-with-atmos
      - command: workflow deploy/iam-role -f quickstart/app/app-on-lambda-with-atmos
      - command: workflow deploy/artifact-bucket -f quickstart/app/app-on-lambda-with-atmos

  init/artifact-bucket:
    description: |
      This workflow deploys the artifact bucket for the app-on-lambda-with-atmos workflow.
    steps:
      - command: terraform deploy s3-bucket/github-action-artifacts -s core-us-east-1-artifacts -var "privileged_principal_arns=[]"

  deploy/artifact-bucket:
    description: |
      This workflow deploys the artifact bucket for the app-on-lambda-with-atmos workflow.
    steps:
      - command: terraform deploy s3-bucket/github-action-artifacts -s core-us-east-1-artifacts

  deploy/iam-role:
    description: |
      This workflow deploys the iam-role for the app-on-lambda-with-atmos workflow.
      TODO: Create iam-role/lambda-publish catalog configuration to replace github-oidc-role/lambda-publish
    steps:
      # TODO: Add iam-role/lambda-publish deployment
      # - command: terraform deploy iam-role/lambda-publish -s core-gbl-artifacts
      - command: echo "TODO - iam-role/lambda-publish deployment not yet configured"

  init/app-on-lambda-with-atmos:
    description: Initializes SSM parameters for app-on-lambda-with-atmos, these are not valid until the github actions run to update the values.
    steps:
      - type: shell
        name: setup ssm params
        command: |-
          profiles=( "acme-plat-gbl-dev-admin" "acme-plat-gbl-sandbox-admin" "acme-plat-gbl-staging-admin" "acme-plat-gbl-prod-admin" )
          for profile in ${profiles[@]} ; do
              aws --profile $profile ssm put-parameter --name /lambda/app-on-lambda-with-atmos/tag --value 0.0.0 --type String --overwrite
          done
